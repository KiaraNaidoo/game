<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Snake Game</title>
  <style>
    :root {
      /* Default theme: Forest */
      --bg: #263f34;
      --fg: #fafffa;
      --snake: #4ac16d;
      --snake-shadow: #184d39cc;
      --snake-eye: #1c2833;
      --snake-tongue: #b80000;
      --apple: #ff595e;
      --apple-shine: #fff8;
      --apple-stem: #7e4f2e;
      --apple-leaf: #86bb6a;
      --special-fruit: #ffde59;
      --board: #335c43;
      --board-grid: #82b29a;
      --board-patch: #4e7d63;
      --score-bg: #1f4633c2;
      --button-bg: #4ac16d;
      --button-fg: #222;
      --button-hover: #388e47;
      --border: #fafffa70;
      --title-shadow: 0 2px 18px #4ac16d88;
      --footer-bg: #2e4a3f;
      --footer-fg: #fafffa;
      --footer-border: #4ac16d;
    }
    .theme-classic {
      /* Classic: Retro LCD */
      --bg: #212121;
      --fg: #e9ff70;
      --snake: #e9ff70;
      --snake-shadow: #b6c85099;
      --snake-eye: #232323;
      --snake-tongue: #e9635e;
      --apple: #d7263d;
      --apple-shine: #ffff;
      --apple-stem: #b6c850;
      --apple-leaf: #e9ff70;
      --special-fruit: #fdd835;
      --board: #343a40;
      --board-grid: #b6c85055;
      --board-patch: #393e46;
      --score-bg: #232323d1;
      --button-bg: #e9ff70;
      --button-fg: #222;
      --button-hover: #b6c850;
      --border: #e9ff70;
      --title-shadow: 0 2px 18px #e9ff7080;
      --footer-bg: #232323;
      --footer-fg: #e9ff70;
      --footer-border: #e9ff70;
    }
    .theme-neon {
      /* Neon Cyberpunk */
      --bg: #0e002e;
      --fg: #fae;
      --snake: #00ffd0;
      --snake-shadow: #00ffd099;
      --snake-eye: #0e002e;
      --snake-tongue: #ff008e;
      --apple: #ff008e;
      --apple-shine: #fff7;
      --apple-stem: #7d0cff;
      --apple-leaf: #00ffd0;
      --special-fruit: #ffe347;
      --board: #1d133b;
      --board-grid: #00ffd033;
      --board-patch: #032d37;
      --score-bg: #341167b9;
      --button-bg: #ff008e;
      --button-fg: #fff;
      --button-hover: #8f00ff;
      --border: #00ffd0;
      --title-shadow: 0 2px 22px #00ffd077;
      --footer-bg: #18003a;
      --footer-fg: #fae;
      --footer-border: #00ffd0;
    }
    .theme-pastel {
      /* Pastel Playful */
      --bg: #f7f3ff;
      --fg: #615375;
      --snake: #b8c1ec;
      --snake-shadow: #cbc0d399;
      --snake-eye: #ef798a;
      --snake-tongue: #ef798a;
      --apple: #ef798a;
      --apple-shine: #fff8;
      --apple-stem: #b8b3e9;
      --apple-leaf: #b8c1ec;
      --special-fruit: #ffb7b2;
      --board: #f3e9ff;
      --board-grid: #b8c1ec33;
      --board-patch: #e2eafc;
      --score-bg: #c1b4d6c2;
      --button-bg: #ef798a;
      --button-fg: #fff;
      --button-hover: #b8c1ec;
      --border: #ef798a;
      --title-shadow: 0 2px 16px #ef798a55;
      --footer-bg: #b8c1ec;
      --footer-fg: #615375;
      --footer-border: #ef798a;
    }
    .theme-oled {
      /* OLED High Contrast */
      --bg: #000;
      --fg: #17ff00;
      --snake: #17ff00;
      --snake-shadow: #0f088a99;
      --snake-eye: #000;
      --snake-tongue: #ff1744;
      --apple: #ff1744;
      --apple-shine: #fff9;
      --apple-stem: #17ff00;
      --apple-leaf: #39ff14;
      --special-fruit: #fff700;
      --board: #222;
      --board-grid: #17ff0035;
      --board-patch: #0e0e0e;
      --score-bg: #000d;
      --button-bg: #17ff00;
      --button-fg: #000;
      --button-hover: #0f0;
      --border: #17ff00;
      --title-shadow: 0 2px 18px #17ff0088;
      --footer-bg: #000;
      --footer-fg: #17ff00;
      --footer-border: #17ff00;
    }
    /* --- Decorative Dynamic Themes Below --- */
    .theme-galaxy {
      /* Galaxy: Cosmic purples, swirling starfields */
      --bg: #14022e;
      --fg: #f3e8ff;
      --snake: #7f63ff;
      --snake-shadow: #391c6bcc;
      --snake-eye: #fdfffc;
      --snake-tongue: #ff96f9;
      --apple: #fcb900;
      --apple-shine: #fff6;
      --apple-stem: #7e4f2e;
      --apple-leaf: #00ffe0;
      --special-fruit: #ff4efd;
      --board: #1e0a3c;
      --board-grid: #7f63ff44;
      --board-patch: #3e296b;
      --score-bg: #2a135dc4;
      --button-bg: #7f63ff;
      --button-fg: #fff;
      --button-hover: #ff4efd;
      --border: #fdfffc88;
      --title-shadow: 0 2px 22px #7f63ff88;
      --footer-bg: #1e0a3c;
      --footer-fg: #f3e8ff;
      --footer-border: #7f63ff;
    }
    .theme-sunset {
      /* Sunset: Orange, magenta, gradient sky */
      --bg: linear-gradient(180deg,#ffb56b 0%,#ff6e91 70%,#2e044e 100%);
      --fg: #fff7eb;
      --snake: #fd6d0a;
      --snake-shadow: #b74e03cc;
      --snake-eye: #2e044e;
      --snake-tongue: #ff2e63;
      --apple: #ff2e63;
      --apple-shine: #fff7;
      --apple-stem: #b74e03;
      --apple-leaf: #ffe156;
      --special-fruit: #2ec4b6;
      --board: #ffb56b33;
      --board-grid: #ff2e6333;
      --board-patch: #ffe15644;
      --score-bg: #ffb56b66;
      --button-bg: #ff6e91;
      --button-fg: #fff;
      --button-hover: #fd6d0a;
      --border: #ff2e63;
      --title-shadow: 0 2px 18px #ff6e9177;
      --footer-bg: #2e044e;
      --footer-fg: #fff7eb;
      --footer-border: #fd6d0a;
    }
    .theme-arcade {
      /* Arcade: Vibrant blues, magenta, grid lines */
      --bg: #0b0e3e;
      --fg: #fff0fc;
      --snake: #f50057;
      --snake-shadow: #0c88f5aa;
      --snake-eye: #fff;
      --snake-tongue: #21f6ff;
      --apple: #21f6ff;
      --apple-shine: #ffffff88;
      --apple-stem: #16b1ff;
      --apple-leaf: #0fffca;
      --special-fruit: #ffea00;
      --board: #1b1542;
      --board-grid: #f5005740;
      --board-patch: #0c88f522;
      --score-bg: #0c88f5bb;
      --button-bg: #f50057;
      --button-fg: #fff;
      --button-hover: #21f6ff;
      --border: #21f6ffcc;
      --title-shadow: 0 2px 19px #21f6ff7a;
      --footer-bg: #1b1542;
      --footer-fg: #fff0fc;
      --footer-border: #f50057;
    }
    .theme-bloom {
      /* Bloom: Spring colors, leaves, floral */
      --bg: #f6fbe6;
      --fg: #4a7352;
      --snake: #95d93b;
      --snake-shadow: #d4f2be99;
      --snake-eye: #4a7352;
      --snake-tongue: #e65a6a;
      --apple: #e65a6a;
      --apple-shine: #fff7;
      --apple-stem: #8b5f30;
      --apple-leaf: #95d93b;
      --special-fruit: #f9c846;
      --board: #e6f9df;
      --board-grid: #b2e8a6bb;
      --board-patch: #f4e1e7;
      --score-bg: #c0e3b0e3;
      --button-bg: #e65a6a;
      --button-fg: #fff;
      --button-hover: #95d93b;
      --border: #e65a6a;
      --title-shadow: 0 2px 15px #e65a6a55;
      --footer-bg: #b2e8a6;
      --footer-fg: #4a7352;
      --footer-border: #e65a6a;
    }
    .theme-midnight {
      /* Midnight Prism: Deep blue, rainbow accents */
      --bg: #0a1633;
      --fg: #c8e8ff;
      --snake: #3c9dff;
      --snake-shadow: #2a53a4cc;
      --snake-eye: #fff;
      --snake-tongue: #ffbc00;
      --apple: #d200ff;
      --apple-shine: #fff8;
      --apple-stem: #584cff;
      --apple-leaf: #3c9dff;
      --special-fruit: #00ffc8;
      --board: #14204d;
      --board-grid: #00ffc822;
      --board-patch: #3c9dff22;
      --score-bg: #14204db9;
      --button-bg: #3c9dff;
      --button-fg: #fff;
      --button-hover: #d200ff;
      --border: #00ffc8bb;
      --title-shadow: 0 2px 19px #00ffc877;
      --footer-bg: #14204d;
      --footer-fg: #c8e8ff;
      --footer-border: #3c9dff;
    }
    body {
      min-height: 100vh;
      margin: 0;
      background: var(--bg);
      font-family: 'Segoe UI', Arial, sans-serif;
      color: var(--fg);
      display: flex;
      flex-direction: column;
    }
    #mainContainer {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      flex: 1 0 auto;
      padding-bottom: 72px;
      box-sizing: border-box;
    }
    #themeSelector {
      position: absolute;
      top: 24px;
      right: 32px;
      z-index: 10;
      background: var(--score-bg);
      border-radius: 14px;
      padding: 8px 20px;
      color: var(--fg);
      border: 2px solid var(--border);
      font-size: 1em;
      font-weight: 600;
      outline: none;
      box-shadow: 0 2px 12px #0004;
      appearance: none;
      margin-bottom: 14px;
      transition: background 0.4s, color 0.4s, border 0.4s;
    }
    #fixedGridWrapper {
      width: 650px;
      height: 800px;
      box-sizing: border-box;
      background: var(--board);
      border-radius: 24px;
      box-shadow: 0 8px 32px #0004;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      margin: 2rem 0 1rem 0;
      border: 5px solid var(--border);
      overflow: hidden;
      user-select: none;
    }
    #gameTitle {
      color: var(--fg);
      font-size: 2.3em;
      margin: 24px 0 15px 0;
      text-align: center;
      text-shadow: var(--title-shadow);
      letter-spacing: 1px;
      transition: color 0.4s, text-shadow 0.4s;
    }
    #score {
      color: var(--fg);
      background: var(--score-bg);
      font-size: 1.35em;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 8px;
      padding: 8px 26px;
      border-radius: 10px;
      min-width: 120px;
      text-align: center;
      box-shadow: 0 1px 8px #0002;
      border: 2px solid var(--border);
      transition: background 0.3s, color 0.3s, border 0.3s;
      width: 350px;
      align-self: center;
    }
    canvas#game {
      display: block;
      margin: 0 auto;
      width: 600px !important;
      height: 600px !important;
      border-radius: 16px;
      background: var(--board);
      box-shadow: 0 4px 16px #0006;
      border: 4px solid var(--border);
      max-width: 600px;
      max-height: 600px;
      transition: border-color 0.3s, background 0.4s;
      box-sizing: border-box;
      position: relative;
    }
    @media (max-width: 700px) {
      #mainContainer {
        padding: 0 0 72px 0;
      }
      #fixedGridWrapper {
        width: 98vw;
        height: 120vw;
        min-width: 0;
        min-height: 0;
      }
      canvas#game {
        width: 94vw !important;
        height: 94vw !important;
        max-width: 97vw;
        max-height: 97vw;
      }
      #score {
        width: 60vw;
        min-width: 0;
      }
    }
    #footer {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100vw;
      background: var(--footer-bg);
      color: var(--footer-fg);
      text-align: center;
      padding: 14px 0 10px 0;
      border-top: 1px solid var(--footer-border);
      font-size: 1.1em;
      z-index: 100;
      box-shadow: 0 -2px 16px #0004;
      user-select: none;
      transition: background 0.4s, color 0.4s, border 0.4s;
    }
    #footer a {
      color: var(--footer-fg);
      text-decoration: underline;
      font-weight: 600;
      transition: color 0.2s;
    }
    #footer a:hover {
      color: var(--apple);
    }
  </style>
</head>
<body>
  <div id="mainContainer">
    <select id="themeSelector" aria-label="Choose Theme">
      <option value="">Forest (Default)</option>
      <option value="classic">Retro LCD</option>
      <option value="neon">Cyberpunk Neon</option>
      <option value="pastel">Pastel Playful</option>
      <option value="oled">OLED Contrast</option>
      <option value="galaxy">Galaxy Cosmic</option>
      <option value="sunset">Sunset Gradient</option>
      <option value="arcade">Arcade Vibrant</option>
      <option value="bloom">Spring Bloom</option>
      <option value="midnight">Midnight Prism</option>
    </select>
    <div id="fixedGridWrapper">
      <div id="gameTitle">Snake Game</div>
      <div id="score">Score: 0</div>
      <canvas width="600" height="700" id="game"></canvas>
    </div>
  </div>
  <footer id="footer">
    &copy; <span id="footer-year"></span>
    <a href="https://kiaranaidoo.github.io/Kode/" target="_blank" id="footer-link">Kode</a>
  </footer>
  <script>
    document.getElementById('footer-year').textContent = new Date().getFullYear();

    // Theme switching with persistence
    const themeSelector = document.getElementById("themeSelector");
    function setTheme(theme) {
      document.body.classList.remove(
        "theme-classic", "theme-neon", "theme-pastel", "theme-oled",
        "theme-galaxy", "theme-sunset", "theme-arcade", "theme-bloom", "theme-midnight"
      );
      if(theme) document.body.classList.add("theme-" + theme);
      localStorage.setItem('snakeTheme', theme);
    }
    const savedTheme = localStorage.getItem('snakeTheme') || "";
    themeSelector.value = savedTheme;
    setTheme(savedTheme);

    themeSelector.addEventListener("change", function() {
      setTheme(themeSelector.value);
      draw();
    });

    // --- Game setup ---
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('score');

    const GRID_SIZE = 15;
    const COLS = 20, ROWS = 20;
    const SNAKE_RADIUS = GRID_SIZE * 0.42;

    let snake = [], direction = {x: 1, y: 0}, nextDir = {x: 1, y: 0};
    let apple = {x: 13, y: 13};
    let specialFruit = null;
    let specialFruitActive = false;
    let score = 0;
    let running = true;
    let tick = 0;
    let grow = 0;
    let specialFruitInterval = null;
    let specialFruitTimeout = null;
    let specialFruitDuration = 10;

    function resizeCanvas() { draw(); }
    window.addEventListener('resize', resizeCanvas);

    function startGame() {
      snake = [
        {x: 7, y: 13, dir: {x: 1, y: 0}},
        {x: 6, y: 13, dir: {x: 1, y: 0}},
        {x: 5, y: 13, dir: {x: 1, y: 0}},
      ];
      direction = {x: 1, y: 0};
      nextDir = {x: 1, y: 0};
      score = 0;
      grow = 0;
      running = true;
      scoreDisplay.textContent = "Score: 0";
      placeApple();
      removeSpecialFruit();
      clearInterval(specialFruitInterval);
      specialFruitInterval = setInterval(spawnSpecialFruit, 30000);
      setTimeout(spawnSpecialFruit, 30000);
      requestAnimationFrame(gameLoop);
    }

    function placeApple() {
      let empty = [];
      for (let x = 0; x < COLS; ++x) {
        for (let y = 0; y < ROWS; ++y) {
          if (
            !snake.some(seg => seg.x === x && seg.y === y) &&
            (!specialFruit || specialFruit.x !== x || specialFruit.y !== y)
          ) {
            empty.push({x, y});
          }
        }
      }
      apple = empty[Math.floor(Math.random() * empty.length)];
    }

    function spawnSpecialFruit() {
      if (specialFruitActive) return;
      let empty = [];
      for (let x = 0; x < COLS; ++x) {
        for (let y = 0; y < ROWS; ++y) {
          if (
            !snake.some(seg => seg.x === x && seg.y === y) &&
            (apple.x !== x || apple.y !== y)
          ) {
            empty.push({x, y});
          }
        }
      }
      if (empty.length === 0) return;
      specialFruit = empty[Math.floor(Math.random() * empty.length)];
      specialFruitActive = true;
      specialFruitTimeout = setTimeout(() => {
        removeSpecialFruit();
      }, specialFruitDuration * 1000);
    }

    function removeSpecialFruit() {
      specialFruit = null;
      specialFruitActive = false;
      if (specialFruitTimeout) {
        clearTimeout(specialFruitTimeout);
        specialFruitTimeout = null;
      }
    }

    function drawBackground() {
      const style = getComputedStyle(document.body);
      const bg = style.getPropertyValue("--bg").trim();
      const board = style.getPropertyValue("--board").trim();
      const gridColor = style.getPropertyValue("--board-grid").trim();
      const patchColor = style.getPropertyValue("--board-patch").trim();

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Galaxy
      if(document.body.classList.contains("theme-galaxy")) {
        ctx.save();
        let grad = ctx.createRadialGradient(
          canvas.width/2, canvas.height/2, 50,
          canvas.width/2, canvas.height/2, Math.max(canvas.width,canvas.height)/1.2
        );
        grad.addColorStop(0, "#2e0c52");
        grad.addColorStop(0.5, "#371d6b");
        grad.addColorStop(1, "#14022e");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for(let i=0; i<60; ++i) {
          let sx = Math.abs(Math.sin(Date.now()/700+i))*canvas.width;
          let sy = Math.abs(Math.cos(Date.now()/900+i*2))*canvas.height;
          ctx.beginPath();
          ctx.arc(sx, sy, Math.random()*1.9+0.7, 0, 2*Math.PI);
          ctx.fillStyle = `rgba(255,255,255,${0.6+0.4*Math.random()})`;
          ctx.fill();
        }
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(Date.now()/40000);
        for(let i=0; i<5; ++i) {
          ctx.beginPath();
          for(let t=0; t<Math.PI*2; t+=0.07) {
            let r = 200 + 22*Math.sin(t*7+i);
            ctx.lineTo(Math.cos(t+i)*r, Math.sin(t+i)*r);
          }
          ctx.strokeStyle = `rgba(255,78,253,0.08)`;
          ctx.lineWidth = 7.5-i;
          ctx.stroke();
        }
        ctx.restore();
        ctx.restore();
      } else if(document.body.classList.contains("theme-sunset")) {
        let grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        let t = Math.sin(Date.now()/1500)*0.1+0.5;
        grad.addColorStop(0, "#ffb56b");
        grad.addColorStop(0.45+t*0.2, "#ff6e91");
        grad.addColorStop(1, "#2e044e");
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        ctx.arc(canvas.width/2, canvas.height*0.83, 96+12*Math.sin(Date.now()/600), 0, 2*Math.PI);
        ctx.fillStyle = "#ffe15644";
        ctx.globalAlpha = 1;
        ctx.shadowColor = "#ffe156";
        ctx.shadowBlur = 38;
        ctx.fill();
        ctx.shadowBlur = 0;
        for(let i=0; i<4; ++i) {
          ctx.beginPath();
          let cx = canvas.width/3 + i*canvas.width/6 + Math.sin(Date.now()/700+i)*30;
          let cy = 120+i*30+Math.cos(Date.now()/800+i*2)*18;
          ctx.ellipse(cx, cy, 50, 18, 0, 0, Math.PI*2);
          ctx.fillStyle = "#fff5";
          ctx.globalAlpha = 0.38;
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      } else if(document.body.classList.contains("theme-arcade")) {
        ctx.save();
        ctx.fillStyle = "#0b0e3e";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "#21f6ff44";
        ctx.lineWidth = 2;
        let offset = (Date.now()/50)%30;
        for(let x=0; x<canvas.width; x+=30) {
          ctx.beginPath();
          ctx.moveTo(x+offset, 0);
          ctx.lineTo(x+offset, canvas.height);
          ctx.stroke();
        }
        for(let y=0; y<canvas.height; y+=30) {
          ctx.beginPath();
          ctx.moveTo(0, y+offset);
          ctx.lineTo(canvas.width, y+offset);
          ctx.stroke();
        }
        for(let y=0; y<canvas.height; y+=6) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.strokeStyle = "#f5005722";
          ctx.globalAlpha = 0.7;
          ctx.lineWidth = 1;
          ctx.stroke();
        }
        ctx.globalAlpha = 1;
        ctx.restore();
      } else if(document.body.classList.contains("theme-bloom")) {
        ctx.save();
        ctx.fillStyle = "#f6fbe6";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for(let i=0; i<7; ++i) {
          ctx.save();
          ctx.translate(
            (canvas.width/6)*i + Math.sin(Date.now()/1100+i)*38,
            55+Math.cos(Date.now()/1000+i)*16
          );
          ctx.rotate(Math.PI/12*Math.sin(Date.now()/700+i));
          ctx.beginPath();
          ctx.ellipse(0, 0, 18+8*Math.abs(Math.sin(Date.now()/600+i)), 40, 0, 0, Math.PI*2);
          ctx.fillStyle = "#95d93b33";
          ctx.fill();
          ctx.restore();
        }
        for(let i=0; i<4; ++i) {
          ctx.save();
          let cx = (canvas.width/5)*(i+1), cy = 180+Math.sin(Date.now()/800+i)*20;
          for(let p=0;p<6;p++) {
            ctx.beginPath();
            ctx.ellipse(
              cx+Math.cos(p*Math.PI/3)*12, cy+Math.sin(p*Math.PI/3)*12,
              10, 18, p*Math.PI/3, 0, Math.PI*2
            );
            ctx.fillStyle = "#e65a6a44";
            ctx.fill();
          }
          ctx.beginPath();
          ctx.arc(cx, cy, 9, 0, 2*Math.PI);
          ctx.fillStyle = "#f9c846aa";
          ctx.fill();
          ctx.restore();
        }
        ctx.restore();
      } else if(document.body.classList.contains("theme-midnight")) {
        ctx.save();
        let grad = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
        grad.addColorStop(0, "#0a1633");
        grad.addColorStop(1, "#1a2d4d");
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,canvas.width,canvas.height);
        for(let i=0;i<6;i++){
          ctx.save();
          ctx.globalAlpha = 0.13+0.1*Math.abs(Math.sin(Date.now()/1100+i));
          ctx.strokeStyle = ["#ffbc00","#ff0080","#00ffc8","#d200ff","#3c9dff","#fff"][i];
          ctx.lineWidth = 10+6*Math.abs(Math.sin(Date.now()/700+i));
          ctx.beginPath();
          ctx.moveTo(canvas.width/2, canvas.height/2);
          ctx.lineTo(canvas.width*Math.sin(i+Date.now()/1300), canvas.height*Math.cos(i+Date.now()/1300));
          ctx.stroke();
          ctx.restore();
        }
        for(let i=0;i<8;i++){
          ctx.beginPath();
          let orbX = canvas.width/4 + (i%4)*canvas.width/6 + Math.sin(Date.now()/600+i)*30;
          let orbY = 70 + (i/4|0)*100 + Math.cos(Date.now()/800+i*2)*28;
          ctx.arc(orbX, orbY, 16+Math.abs(Math.sin(Date.now()/700+i))*7, 0, Math.PI*2);
          ctx.fillStyle = ["#ffbc0044","#ff008033","#00ffc844","#d200ff44","#3c9dff33","#fff3","#ffbc0035","#00ffc835"][i%8];
          ctx.fill();
        }
        ctx.restore();
      } else if(document.body.classList.contains("theme-neon")) {
        const now = Date.now()/500;
        ctx.save();
        for(let i=0; i<canvas.width; i+=24) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, canvas.height);
          ctx.strokeStyle = `rgba(0,255,208,${0.13 + 0.13 * Math.sin(now+i/30)})`;
          ctx.lineWidth = 2 + 2*Math.abs(Math.sin(now+i/80));
          ctx.shadowColor = "#00ffd0";
          ctx.shadowBlur = 9;
          ctx.stroke();
        }
        for(let i=0; i<canvas.height; i+=24) {
          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(canvas.width, i);
          ctx.strokeStyle = `rgba(0,255,208,${0.12 + 0.09 * Math.cos(now+i/28)})`;
          ctx.lineWidth = 2 + 1.5*Math.abs(Math.cos(now+i/65));
          ctx.shadowColor = "#00ffd0";
          ctx.shadowBlur = 7;
          ctx.stroke();
        }
        for(let i=0; i<8; ++i) {
          ctx.beginPath();
          ctx.arc(
            (canvas.width/2)+(Math.cos(now+i)*150),
            (canvas.height/2)+(Math.sin(now+i*1.2)*180),
            10+6*Math.abs(Math.sin(now+i)),
            0, 2*Math.PI
          );
          ctx.fillStyle = `rgba(255,0,142,${0.15 + 0.12*Math.abs(Math.sin(now+i))}`;
          ctx.shadowColor = "#ff008e";
          ctx.shadowBlur = 18;
          ctx.fill();
        }
        ctx.restore();
      } else if(document.body.classList.contains("theme-pastel")) {
        ctx.save();
        for(let i=0; i<16; ++i) {
          ctx.beginPath();
          ctx.arc(
            (i%4)*(canvas.width/3)+Math.sin(Date.now()/600+i)*12,
            Math.floor(i/4)*(canvas.height/5)+Math.cos(Date.now()/800+i)*18,
            24+10*Math.abs(Math.sin(Date.now()/1000+i)),
            0, 2*Math.PI
          );
          ctx.fillStyle = i%2===0 ? "#ef798a33" : "#b8c1ec55";
          ctx.globalAlpha = 0.33;
          ctx.fill();
        }
        ctx.globalAlpha = 1;
        ctx.restore();
      } else if(document.body.classList.contains("theme-oled")) {
        ctx.save();
        let now = Date.now()/400;
        for(let i=1; i<COLS; i++) {
          ctx.beginPath();
          ctx.moveTo(i*canvas.width/COLS, 0);
          ctx.lineTo(i*canvas.width/COLS, canvas.height);
          ctx.strokeStyle = `rgba(23,255,0,${0.14 + 0.12*Math.abs(Math.sin(now+i))})`;
          ctx.lineWidth = 1;
          ctx.stroke();
        }
        for(let y=1; y<ROWS; y++) {
          ctx.beginPath();
          ctx.moveTo(0, y*canvas.height/ROWS);
          ctx.lineTo(canvas.width, y*canvas.height/ROWS);
          ctx.strokeStyle = `rgba(23,255,0,${0.11 + 0.1*Math.abs(Math.cos(now+y))})`;
          ctx.lineWidth = 1;
          ctx.stroke();
        }
        for(let y=0; y<canvas.height; y+=4) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.strokeStyle = "rgba(23,255,0,0.07)";
          ctx.lineWidth = 2;
          ctx.stroke();
        }
        ctx.restore();
      } else if(document.body.classList.contains("theme-classic")) {
        ctx.fillStyle = board;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for(let i=1; i<COLS; i++) {
          ctx.beginPath();
          ctx.moveTo(i*canvas.width/COLS, 0);
          ctx.lineTo(i*canvas.width/COLS, canvas.height);
          ctx.strokeStyle = gridColor;
          ctx.lineWidth = 1.2;
          ctx.globalAlpha = 0.45;
          ctx.stroke();
        }
        for(let y=1; y<ROWS; y++) {
          ctx.beginPath();
          ctx.moveTo(0, y*canvas.height/ROWS);
          ctx.lineTo(canvas.width, y*canvas.height/ROWS);
          ctx.strokeStyle = gridColor;
          ctx.lineWidth = 1.2;
          ctx.globalAlpha = 0.45;
          ctx.stroke();
        }
        ctx.globalAlpha = 1;
        for(let i=0; i<8; ++i) {
          ctx.beginPath();
          ctx.arc(
            Math.random()*canvas.width,
            Math.random()*canvas.height,
            32+Math.random()*24,
            0, 2*Math.PI
          );
          ctx.fillStyle = patchColor;
          ctx.globalAlpha = 0.13;
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      } else {
        // Default forest
        ctx.fillStyle = board;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for(let i=0; i<18; i++) {
          const px = Math.random()*canvas.width;
          const py = Math.random()*canvas.height;
          const rad = Math.random()*32+16;
          ctx.beginPath();
          ctx.arc(px, py, rad, 0, Math.PI*2);
          ctx.fillStyle = patchColor;
          ctx.globalAlpha = 0.09;
          ctx.fill();
        }
        ctx.globalAlpha = 1;
        ctx.strokeStyle = gridColor;
        ctx.lineWidth = 1;
        for(let x=1; x<COLS; x++) {
          ctx.beginPath();
          ctx.moveTo(x*canvas.width/COLS, 0);
          ctx.lineTo(x*canvas.width/COLS, canvas.height);
          ctx.stroke();
        }
        for(let y=1; y<ROWS; y++) {
          ctx.beginPath();
          ctx.moveTo(0, y*canvas.height/ROWS);
          ctx.lineTo(canvas.width, y*canvas.height/ROWS);
          ctx.stroke();
        }
      }
      ctx.globalAlpha = 1;
    }

    function drawApple() {
      const style = getComputedStyle(document.body);
      const APPLE_RADIUS = GRID_SIZE * 0.39 * (1 + 0.05 * Math.sin(Date.now()/300));
      const APPLE_COLOR = style.getPropertyValue("--apple").trim();
      const APPLE_SHINE = style.getPropertyValue("--apple-shine").trim();
      const APPLE_STEM = style.getPropertyValue("--apple-stem").trim();
      const APPLE_LEAF = style.getPropertyValue("--apple-leaf").trim();

      const cx = (apple.x+0.5)*canvas.width/COLS;
      const cy = (apple.y+0.5)*canvas.height/ROWS;

      let grad = ctx.createRadialGradient(cx-3, cy-5, 2, cx, cy, APPLE_RADIUS);
      grad.addColorStop(0, '#fff8');
      grad.addColorStop(0.2, APPLE_COLOR);
      grad.addColorStop(1, '#a31926');
      ctx.beginPath();
      ctx.arc(cx, cy, APPLE_RADIUS, 0, Math.PI*2);
      ctx.fillStyle = grad;
      ctx.shadowColor = "#7e2323";
      ctx.shadowBlur = 10;
      ctx.fill();
      ctx.shadowBlur = 0;

      ctx.beginPath();
      ctx.ellipse(cx-APPLE_RADIUS/2, cy-APPLE_RADIUS/3, APPLE_RADIUS/3, APPLE_RADIUS/6, -Math.PI/6, 0, Math.PI*2);
      ctx.fillStyle = APPLE_SHINE;
      ctx.globalAlpha = 0.6;
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.beginPath();
      ctx.moveTo(cx, cy-APPLE_RADIUS+4);
      ctx.lineTo(cx+2, cy-APPLE_RADIUS-8);
      ctx.lineWidth = 4;
      ctx.strokeStyle = APPLE_STEM;
      ctx.stroke();

      ctx.beginPath();
      ctx.ellipse(cx+10, cy-APPLE_RADIUS, 8, 4, Math.PI/5, 0, Math.PI*2);
      ctx.fillStyle = APPLE_LEAF;
      ctx.fill();
    }

    function drawSpecialFruit() {
      if (!specialFruitActive || !specialFruit) return;
      const style = getComputedStyle(document.body);
      const SPECIAL_COLOR = style.getPropertyValue('--special-fruit').trim() || "#fff700";
      const cx = (specialFruit.x+0.5)*canvas.width/COLS;
      const cy = (specialFruit.y+0.5)*canvas.height/ROWS;
      const FR = GRID_SIZE * 0.46 * (1 + 0.15 * Math.sin(Date.now()/200));
      let grad = ctx.createRadialGradient(cx, cy, 2, cx, cy, FR);
      grad.addColorStop(0.1, "#fff");
      grad.addColorStop(0.3, SPECIAL_COLOR);
      grad.addColorStop(1, "#fff70000");
      ctx.beginPath();
      ctx.arc(cx, cy, FR, 0, 2*Math.PI);
      ctx.fillStyle = grad;
      ctx.shadowColor = SPECIAL_COLOR;
      ctx.shadowBlur = 18;
      ctx.globalAlpha = 0.93;
      ctx.fill();
      ctx.globalAlpha = 1;

      // Star icon
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(Date.now()/700);
      ctx.beginPath();
      for (let i = 0; i < 5; i++) {
        ctx.lineTo(0, -FR + 2);
        ctx.rotate(Math.PI / 5);
        ctx.lineTo(0, -FR * 0.47);
        ctx.rotate(Math.PI / 5);
      }
      ctx.closePath();
      ctx.fillStyle = "#fff";
      ctx.globalAlpha = 0.9;
      ctx.shadowColor = SPECIAL_COLOR;
      ctx.shadowBlur = 8;
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;
      ctx.restore();
    }

    function drawSnake() {
      const style = getComputedStyle(document.body);
      const SNAKE_COLOR = style.getPropertyValue("--snake").trim();
      const SNAKE_EYE_COLOR = style.getPropertyValue("--snake-eye").trim();
      const SNAKE_TONGUE_COLOR = style.getPropertyValue("--snake-tongue").trim();
      const SNAKE_SHADOW_COLOR = style.getPropertyValue("--snake-shadow").trim();

      for(let i=snake.length-1; i>=0; i--) {
        let seg = snake[i];
        const cx = (seg.x+0.5)*canvas.width/COLS;
        const cy = (seg.y+0.5)*canvas.height/ROWS;

        ctx.beginPath();
        ctx.arc(cx, cy + 3, SNAKE_RADIUS, 0, Math.PI*2);
        ctx.fillStyle = SNAKE_SHADOW_COLOR;
        ctx.globalAlpha = 0.5;
        ctx.fill();
        ctx.globalAlpha = 1;

        let grad = ctx.createRadialGradient(cx-4, cy-4, 3, cx, cy, SNAKE_RADIUS);
        grad.addColorStop(0, "#f0f7e6");
        grad.addColorStop(0.5, SNAKE_COLOR);
        grad.addColorStop(1, "#1c2833");
        ctx.beginPath();
        ctx.arc(cx, cy, SNAKE_RADIUS, 0, Math.PI*2);
        ctx.fillStyle = grad;
        ctx.fill();

        if(i === 0) {
          let dx = seg.dir.x, dy = seg.dir.y;
          let ex = cx + (dx*7 || 0) + (dy !== 0 ? 6 : 0);
          let ey = cy + (dy*7 || 0) + (dx !== 0 ? 6 : 0);
          ctx.beginPath();
          ctx.arc(ex-5*dy, ey-5*dx, 3.5, 0, Math.PI*2);
          ctx.arc(ex+5*dy, ey+5*dx, 3.5, 0, Math.PI*2);
          ctx.fillStyle = SNAKE_EYE_COLOR;
          ctx.fill();

          if(tick%12 < 6) {
            ctx.save();
            ctx.strokeStyle = SNAKE_TONGUE_COLOR;
            ctx.lineWidth = 2.3;
            ctx.beginPath();
            ctx.moveTo(cx + dx*(SNAKE_RADIUS-2), cy + dy*(SNAKE_RADIUS-2));
            let tx = cx + dx*(SNAKE_RADIUS+14);
            let ty = cy + dy*(SNAKE_RADIUS+14);
            ctx.lineTo(tx, ty);
            ctx.moveTo(tx-3*dy, ty+3*dx);
            ctx.lineTo(tx+3*dy, ty-3*dx);
            ctx.stroke();
            ctx.restore();
          }
        }
      }
    }

    function draw() {
      drawBackground();
      drawApple();
      drawSpecialFruit();
      drawSnake();
    }

    // --- Controls ---
    function handleMoveInput(dir) {
      let d = direction;
      if (dir === "left" && d.x === 0) nextDir = {x: -1, y: 0};
      else if (dir === "up" && d.y === 0) nextDir = {x: 0, y: -1};
      else if (dir === "right" && d.x === 0) nextDir = {x: 1, y: 0};
      else if (dir === "down" && d.y === 0) nextDir = {x: 0, y: 1};
      else if (dir === "space") {
        if (!running) startGame();
      }
    }

    document.addEventListener('keydown', function (e) {
      if (document.activeElement === themeSelector) return;
      if (e.key === "ArrowLeft" || e.key === "a") handleMoveInput("left");
      else if (e.key === "ArrowUp" || e.key === "w") handleMoveInput("up");
      else if (e.key === "ArrowRight" || e.key === "d") handleMoveInput("right");
      else if (e.key === "ArrowDown" || e.key === "s") handleMoveInput("down");
      else if (e.code === "Space") handleMoveInput("space");
      else if (!running) startGame();
      else handleMoveInput("right");
    });

    let tsX=0, tsY=0, teX=0, teY=0, touchMoved=false;
    canvas.addEventListener('touchstart', e => {
      touchMoved = false;
      tsX = e.touches[0].clientX; tsY = e.touches[0].clientY;
    });
    canvas.addEventListener('touchmove', e => { touchMoved = true; });
    canvas.addEventListener('touchend', e => {
      teX = e.changedTouches[0].clientX; teY = e.changedTouches[0].clientY;
      let dx = teX-tsX, dy = teY-tsY;
      if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>10) {
        if(dx>0 && direction.x === 0) nextDir = {x:1, y:0};
        else if(dx<0 && direction.x === 0) nextDir = {x:-1, y:0};
      } else if(Math.abs(dy)>10) {
        if(dy>0 && direction.y === 0) nextDir = {x:0, y:1};
        else if(dy<0 && direction.y === 0) nextDir = {x:0, y:-1};
      } else {
        if (!running) startGame();
        else handleMoveInput("right");
      }
    });

    canvas.addEventListener('click', function() {
      if (!running) startGame();
      else handleMoveInput("right");
    });

    function gameLoop() {
      if (!running) return;
      if (++tick % 6 === 0) {
        moveSnake();
      }
      draw();
      requestAnimationFrame(gameLoop);
    }

    function moveSnake() {
      direction = nextDir;
      const head = {...snake[0]};
      head.x += direction.x;
      head.y += direction.y;
      head.dir = {...direction};

      if(head.x < 0) head.x = COLS-1;
      if(head.x >= COLS) head.x = 0;
      if(head.y < 0) head.y = ROWS-1;
      if(head.y >= ROWS) head.y = 0;

      // Eat special fruit
      if (specialFruitActive && specialFruit && head.x === specialFruit.x && head.y === specialFruit.y) {
        grow += 5;
        score += 50;
        scoreDisplay.textContent = "Score: " + score;
        removeSpecialFruit();
      }

      // Eat apple
      if(head.x === apple.x && head.y === apple.y) {
        grow += 3;
        score += 10;
        scoreDisplay.textContent = "Score: " + score;
        placeApple();
      }

      // Collide with self
      if(snake.some(seg => seg.x === head.x && seg.y === head.y)) {
        gameOver();
        return;
      }

      snake.unshift(head);
      if(grow > 0) {
        grow--;
      } else {
        snake.pop();
      }
    }

    function gameOver() {
      running = false;
      draw();
      ctx.save();
      ctx.fillStyle = "rgba(27,27,27,0.92)";
      ctx.fillRect(0, canvas.height/2-60, canvas.width, 120);
      ctx.font = "bold 52px Arial";
      ctx.fillStyle = "#e63946";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("Game Over!", canvas.width/2, canvas.height/2-16);
      ctx.font = "bold 30px Arial";
      ctx.fillStyle = "#fff";
      ctx.fillText("Press Space to Restart", canvas.width/2, canvas.height/2+28);
      ctx.restore();
      removeSpecialFruit();
      clearInterval(specialFruitInterval);
    }

    startGame();
  </script>
</body>
</html>
